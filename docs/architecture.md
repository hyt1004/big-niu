# 架构设计文档

## 系统架构概述

Big Niu 采用前后端分离的架构设计，后端提供 RESTful API，前端通过 HTTP 请求与后端交互。

## 架构图

```
┌──────────────────────────────────────────────────────────────┐
│                          前端层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  用户界面    │  │  状态管理    │  │  API 客户端  │       │
│  │  (React)     │  │  (Zustand)   │  │  (Axios)     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└────────────────────────────┬─────────────────────────────────┘
                             │ HTTPS/WebSocket
┌────────────────────────────┼─────────────────────────────────┐
│                          后端层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  API 网关    │  │  业务逻辑    │  │  任务队列    │       │
│  │  (FastAPI)   │  │  (Service)   │  │  (Celery)    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└────────────────────────────┬─────────────────────────────────┘
                             │
┌────────────────────────────┼─────────────────────────────────┐
│                        AI 服务层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  文本解析    │  │  图像生成    │  │  语音合成    │       │
│  │  (NLP)       │  │  (SD/DALL-E) │  │  (TTS)       │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└────────────────────────────┬─────────────────────────────────┘
                             │
┌────────────────────────────┼─────────────────────────────────┐
│                        存储层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  数据库      │  │  对象存储    │  │  缓存        │       │
│  │  (PostgreSQL)│  │  (七牛云)    │  │  (Redis)     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└──────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 剧本解析模块

**职责**: 将输入的小说文本解析为结构化的剧本数据

**输入**: 
- 小说文本（字符串）

**输出**:
```json
{
  "scenes": [
    {
      "id": "scene_001",
      "description": "场景描述",
      "characters": ["角色A", "角色B"],
      "dialogues": [
        {
          "character": "角色A",
          "text": "对话内容",
          "emotion": "情绪标签"
        }
      ],
      "narration": "旁白文本"
    }
  ],
  "characters": {
    "角色A": {
      "name": "角色A",
      "description": "外貌特征描述",
      "personality": "性格特点"
    }
  }
}
```

**技术方案**:
- 使用 GPT-4 或通义千问进行文本理解
- 提取角色、场景、对话、旁白等关键信息
- 使用 Prompt Engineering 确保输出格式的一致性

### 2. 角色一致性图像生成模块

**职责**: 为每个角色生成一致的视觉形象，并生成场景画面

**技术方案**:
- **角色设定生成**:
  - 第一次生成角色时，使用 Stable Diffusion 生成角色形象
  - 提取角色的关键特征（发型、服装、面部特征等）
  - 保存角色的 seed 和 prompt

- **角色一致性保持**:
  - 使用 LoRA（Low-Rank Adaptation）微调技术
  - 为每个角色训练一个小型模型权重
  - 或使用 ControlNet 保持姿态一致性

- **场景生成**:
  - 根据场景描述生成背景
  - 将角色合成到场景中
  - 使用图像修复技术确保融合自然

### 3. 语音合成模块

**职责**: 为对话和旁白生成语音

**技术方案**:
- 使用 Azure TTS 或阿里云 TTS API
- 为不同角色分配不同的音色
- 根据情绪标签调整语音参数（语速、音调等）
- 生成 MP3 或 WAV 格式音频文件

### 4. 视频合成模块

**职责**: 将图像、音频、字幕合成为视频

**流程**:
```
1. 为每个场景生成图像序列
2. 为每个对话生成音频片段
3. 生成 SRT 格式字幕文件
4. 使用 FFmpeg 合成视频:
   - 图像转视频流
   - 添加音频轨道
   - 叠加字幕
5. 输出 MP4 格式视频
```

**技术细节**:
```bash
ffmpeg -framerate 1 -i scene_%03d.png \
       -i audio.mp3 \
       -vf "subtitles=subtitles.srt" \
       -c:v libx264 -c:a aac \
       output.mp4
```

## 数据流

```
用户输入小说
    ↓
剧本解析 (NLP)
    ↓
角色设定生成 (AI)
    ↓
场景画面生成 (Stable Diffusion)
    ↓
语音合成 (TTS)
    ↓
视频合成 (FFmpeg)
    ↓
上传到七牛云存储
    ↓
返回视频 URL 给前端
```

## 异步处理设计

由于 AI 生成任务耗时较长，采用异步处理机制：

1. 用户提交任务后，立即返回任务 ID
2. 后端使用 Celery 在后台处理任务
3. 前端通过 WebSocket 或轮询获取任务进度
4. 任务完成后，返回视频 URL

**任务状态**:
- `pending`: 等待处理
- `processing`: 处理中
- `completed`: 完成
- `failed`: 失败

## 扩展性设计

### 水平扩展
- API 服务无状态，可通过负载均衡扩展多个实例
- Celery Worker 可以根据负载动态增加

### 模块解耦
- 每个 AI 服务模块独立，可以单独替换或升级
- 使用消息队列实现模块间通信

### 性能优化
- 使用 Redis 缓存中间结果
- 图像和视频存储到 CDN 加速访问
- 数据库查询优化和索引设计

## 安全性设计

- API 使用 JWT 进行身份认证
- 限制用户请求频率（Rate Limiting）
- 敏感数据加密存储
- 输入内容进行安全检查，过滤违规内容
- 使用 HTTPS 加密传输

## 监控和日志

- 使用 Prometheus + Grafana 监控系统性能
- 使用 ELK Stack (Elasticsearch + Logstash + Kibana) 收集和分析日志
- 记录每个任务的处理时间和资源消耗
- 异常自动告警

## 技术选型理由

| 技术 | 选择理由 |
|------|---------|
| FastAPI | 高性能、支持异步、自动生成 API 文档 |
| React | 组件化开发、生态丰富、社区活跃 |
| Stable Diffusion | 开源、可定制、图像质量高 |
| FFmpeg | 功能强大、广泛使用、跨平台 |
| Celery | 成熟的 Python 异步任务队列 |
| Redis | 高性能缓存和消息队列 |
| 七牛云 | 国内访问速度快、API 友好 |
