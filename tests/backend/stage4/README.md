# Stage4 è¯­éŸ³åˆæˆï¼ˆTTSï¼‰æµ‹è¯•

## åŠŸèƒ½æè¿°

Stage4 è´Ÿè´£å°†åœºæ™¯çš„æ—ç™½å’Œè§’è‰²å¯¹è¯è½¬æ¢ä¸ºè¯­éŸ³éŸ³é¢‘æ–‡ä»¶ï¼Œä½¿ç”¨ç«å±±å¼•æ“ TTS æœåŠ¡æä¾›é«˜è´¨é‡çš„è¯­éŸ³åˆæˆã€‚

---

## ğŸ“ Mock æ•°æ®ç»“æ„

```
stage4/mockdata/
â”œâ”€â”€ original_text.txt              # åŸå§‹æ•…äº‹æ–‡æœ¬
â”œâ”€â”€ stage1_output.json             # Stage1 è¾“å‡ºï¼ˆåœºæ™¯ã€è§’è‰²ã€å¯¹è¯ï¼‰
â”œâ”€â”€ stage3_output.json             # Stage3 è¾“å‡ºï¼ˆå›¾åƒä¿¡æ¯ï¼‰
â”œâ”€â”€ stage4_expected_output.json    # é¢„æœŸè¾“å‡ºï¼ˆç”¨äºæµ‹è¯•å¯¹æ¯”ï¼‰
â”œâ”€â”€ images/                        # åœºæ™¯å›¾åƒï¼ˆæ¥è‡ª Stage3ï¼‰
â”‚   â”œâ”€â”€ scene_001.png
â”‚   â”œâ”€â”€ scene_002.png
â”‚   â””â”€â”€ scene_003.png
â””â”€â”€ audio/                         # ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶
    â”œâ”€â”€ scene_001_narration.mp3
    â”œâ”€â”€ scene_001_dialogue_001.mp3
    â””â”€â”€ ...
```

---

## ğŸ¯ æµ‹è¯•å†…å®¹

### å•å…ƒæµ‹è¯• (`test_unit_tts.py`)

- âœ… æµ‹è¯•æ–‡æœ¬æ¸…ç†å’Œé¢„å¤„ç†
- âœ… æµ‹è¯•è§’è‰²éŸ³è‰²åˆ†é…ï¼ˆç«å±±å¼•æ“è¯­éŸ³ç±»å‹ï¼‰
- âœ… æµ‹è¯•æƒ…ç»ªå‚æ•°æ˜ å°„ï¼ˆè¯­é€Ÿã€éŸ³è°ƒã€éŸ³é‡ï¼‰
- âœ… æµ‹è¯•éŸ³é¢‘æ—¶é•¿ä¼°ç®—
- âœ… æµ‹è¯•ç«å±±å¼•æ“ TTS è¯·æ±‚æ ¼å¼
- âœ… æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶

### åŠŸèƒ½æµ‹è¯• (`test_functional_tts.py`)

- âœ… æµ‹è¯•å•ä¸ªæ—ç™½éŸ³é¢‘ç”Ÿæˆ
- âœ… æµ‹è¯•å•ä¸ªå¯¹è¯éŸ³é¢‘ç”Ÿæˆ
- âœ… æµ‹è¯•å®Œæ•´åœºæ™¯éŸ³é¢‘ç”Ÿæˆ
- âœ… æµ‹è¯•éŸ³é¢‘æ–‡ä»¶ä¿å­˜
- âœ… æµ‹è¯•ç«å±±å¼•æ“ TTS é›†æˆ
- âœ… æµ‹è¯•è§’è‰²éŸ³è‰²åˆ†é…ä¸€è‡´æ€§
- âœ… æµ‹è¯•æƒ…ç»ªå‚æ•°æ˜ å°„

### é›†æˆæµ‹è¯• (`test_integration_tts.py`)

- âœ… æµ‹è¯•ä» Stage1 è¾“å‡ºåˆ°éŸ³é¢‘ç”Ÿæˆçš„å®Œæ•´æµç¨‹
- âœ… æµ‹è¯•æ‰€æœ‰åœºæ™¯çš„æ‰¹é‡éŸ³é¢‘ç”Ÿæˆ
- âœ… æµ‹è¯•éŸ³é¢‘æ—¶é•¿ä¸å­—å¹•æ—¶é—´è½´å¯¹é½

---

## ğŸš€ è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰ Stage4 æµ‹è¯•
pytest tests/backend/stage4/ -v

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/backend/stage4/test_unit_tts.py -v

# è¿è¡ŒåŠŸèƒ½æµ‹è¯•
pytest tests/backend/stage4/test_functional_tts.py -v

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/backend/stage4/test_integration_tts.py -v
```

---

## ğŸ“Š è¾“å…¥è¾“å‡ºæ ¼å¼

### è¾“å…¥ï¼ˆStage1 Outputï¼‰

```json
{
  "characters": [
    {
      "id": "char_001",
      "name": "Wang Miao",
      "description": "A middle-aged man in his 40s",
      "age": 45,
      "gender": "male"
    }
  ],
  "scenes": [
    {
      "scene_id": "scene_001",
      "narration": "æ·±å¤œï¼Œæ±ªæ·¼ç«™åœ¨çª—å‰...",
      "dialogues": [
        {
          "character": "char_001",
          "text": "è¿™åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ",
          "emotion": "Anxious and confused"
        }
      ]
    }
  ]
}
```

### è¾“å‡ºï¼ˆStage4 Outputï¼‰

```json
{
  "scenes": [
    {
      "scene_id": "scene_001",
      "audio_segments": [
        {
          "type": "narration",
          "text": "æ·±å¤œï¼Œæ±ªæ·¼ç«™åœ¨çª—å‰...",
          "audio_path": "/path/to/audio/scene_001_narration.mp3",
          "duration": 12.5,
          "start_time": 0.0,
          "voice": "narrator"
        },
        {
          "type": "dialogue",
          "character": "char_001",
          "text": "è¿™åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ",
          "audio_path": "/path/to/audio/scene_001_dialogue_001.mp3",
          "duration": 1.5,
          "start_time": 12.5,
          "voice": "male_middle_aged"
        }
      ],
      "total_duration": 14.0
    }
  ],
  "total_video_duration": 63.5,
  "character_voices": {
    "char_001": "male_middle_aged",
    "char_002": "male_young", 
    "char_003": "female_elderly",
    "narrator": "narrator"
  }
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ç«å±±å¼•æ“ TTS æœåŠ¡

1. **è¯­éŸ³ç±»å‹æ˜ å°„**
   - `BV001_streaming`: æ ‡å‡†å¥³å£°ï¼ˆæ—ç™½ã€å¹´è½»å¥³æ€§ï¼‰
   - `BV700_streaming`: æ ‡å‡†ç”·å£°ï¼ˆä¸­å¹´ç”·æ€§ï¼‰
   - `BV701_streaming`: å¹´è½»ç”·å£°
   - `BV002_streaming`: æˆç†Ÿå¥³å£°ï¼ˆè€å¹´å¥³æ€§ï¼‰

2. **æƒ…ç»ªå‚æ•°æ”¯æŒ**
   - è¯­é€Ÿè°ƒæ•´ï¼š0.9 - 1.2
   - éŸ³è°ƒè°ƒæ•´ï¼š0.9 - 1.1
   - éŸ³é‡è°ƒæ•´ï¼š0.8 - 1.2

3. **éŸ³è‰²åˆ†é…ç­–ç•¥**

```python
character_voices = {
    "char_001": "BV700_streaming",  # Wang Miao - ä¸­å¹´ç”·æ€§
    "char_002": "BV701_streaming",  # Xiao Li - å¹´è½»ç”·æ€§
    "char_003": "BV002_streaming",  # Ye Wenjie - è€å¹´å¥³æ€§
    "narrator": "BV001_streaming"   # æ—ç™½ - æ ‡å‡†å¥³å£°
}
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¿…éœ€çš„ç¯å¢ƒå˜é‡
export VOLCENGINE_APPID="your_appid_here"
export VOLCENGINE_ACCESS_TOKEN="your_access_token_here"

# å¯é€‰çš„ç¯å¢ƒå˜é‡
export VOLCENGINE_CLUSTER="volcano_tts"  # é»˜è®¤ä¸º volcano_tts
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹è¯´æ˜

### Mock æ•°æ®æµ‹è¯•

æµ‹è¯•ä½¿ç”¨ `mockdata/` ç›®å½•ä¸­çš„çœŸå®æ•°æ®ï¼š

1. **åŸå§‹æ–‡æœ¬** (`original_text.txt`): ä¸‰ä½“æ•…äº‹ç‰‡æ®µ
2. **Stage1 è¾“å‡º** (`stage1_output.json`): åŒ…å«3ä¸ªåœºæ™¯ï¼Œ3ä¸ªè§’è‰²
3. **é¢„æœŸè¾“å‡º** (`stage4_expected_output.json`): ç”¨äºéªŒè¯éŸ³é¢‘ç”Ÿæˆç»“æœ

### æµ‹è¯•åœºæ™¯

1. **åœºæ™¯1**: æ±ªæ·¼æ·±å¤œç«™åœ¨çª—å‰ï¼Œçœ‹åˆ°ç¥ç§˜æ•°å­—
2. **åœºæ™¯2**: å®éªŒå®¤ä¸­ï¼Œæ±ªæ·¼ä¸åŠ©æ‰‹å°æçš„å¯¹è¯
3. **åœºæ™¯3**: æ±ªæ·¼æ‹œè®¿å¶æ–‡æ´ï¼Œäº†è§£ä¸‰ä½“æ–‡æ˜çœŸç›¸

### è§’è‰²éŸ³è‰²æµ‹è¯•

- **æ±ªæ·¼** (char_001): ä¸­å¹´ç”·æ€§ç§‘å­¦å®¶ â†’ `BV700_streaming`
- **å°æ** (char_002): å¹´è½»ç”·æ€§åŠ©æ‰‹ â†’ `BV701_streaming`  
- **å¶æ–‡æ´** (char_003): è€å¹´å¥³æ€§å·¥ç¨‹å¸ˆ â†’ `BV002_streaming`
- **æ—ç™½**: æ•…äº‹å™è¿° â†’ `BV001_streaming`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æˆæœ¬æ§åˆ¶**: ç«å±±å¼•æ“ TTS æŒ‰å­—ç¬¦æ”¶è´¹ï¼Œå»ºè®®æµ‹è¯•æ—¶ä½¿ç”¨è¾ƒçŸ­çš„æ–‡æœ¬
2. **éŸ³é¢‘æ ¼å¼**: ç»Ÿä¸€ä½¿ç”¨ MP3 æ ¼å¼ï¼Œé‡‡æ ·ç‡æ ¹æ®ç«å±±å¼•æ“é…ç½®
3. **æ—¶é•¿ä¼°ç®—**: ä¸­æ–‡çº¦ 3-4 å­—/ç§’ï¼Œè‹±æ–‡çº¦ 5-6 å­—/ç§’
4. **ç½‘ç»œä¾èµ–**: éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥è®¿é—®ç«å±±å¼•æ“ API
5. **è®¤è¯è¦æ±‚**: éœ€è¦æœ‰æ•ˆçš„ç«å±±å¼•æ“åº”ç”¨å‡­è¯

---

## ğŸ“ å·²å®ŒæˆåŠŸèƒ½

- âœ… ç«å±±å¼•æ“ TTS æœåŠ¡é›†æˆ
- âœ… æ™ºèƒ½è§’è‰²éŸ³è‰²åˆ†é…
- âœ… æƒ…ç»ªå‚æ•°æ˜ å°„ï¼ˆè¯­é€Ÿã€éŸ³è°ƒã€éŸ³é‡ï¼‰
- âœ… éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆå’Œä¿å­˜
- âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- âœ… é”™è¯¯å¤„ç†å’Œå¼‚å¸¸ç®¡ç†
- âœ… å¹¶å‘éŸ³é¢‘ç”Ÿæˆæ”¯æŒ
- âœ… éŸ³é¢‘æ—¶é•¿ä¼°ç®—
- âœ… æ—¶é—´è½´è®¡ç®—

---

## ğŸ”„ æµ‹è¯•æµç¨‹

1. **å•å…ƒæµ‹è¯•**: éªŒè¯åŸºç¡€åŠŸèƒ½ï¼ˆæ–‡æœ¬å¤„ç†ã€éŸ³è‰²åˆ†é…ã€å‚æ•°æ˜ å°„ï¼‰
2. **åŠŸèƒ½æµ‹è¯•**: éªŒè¯å®Œæ•´éŸ³é¢‘ç”Ÿæˆæµç¨‹ï¼ˆä½¿ç”¨ mockdataï¼‰
3. **é›†æˆæµ‹è¯•**: éªŒè¯ç«¯åˆ°ç«¯æµç¨‹ï¼ˆStage1 â†’ Stage4ï¼‰
4. **æ€§èƒ½æµ‹è¯•**: éªŒè¯å¹¶å‘å¤„ç†å’Œé”™è¯¯æ¢å¤

æµ‹è¯•ç¡®ä¿ç«å±±å¼•æ“ TTS æœåŠ¡èƒ½å¤Ÿæ­£ç¡®è¯»å–æ–‡æœ¬å¹¶ç”Ÿæˆé«˜è´¨é‡çš„è¯­éŸ³éŸ³é¢‘ã€‚
